name: Approve and Merge PR

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
      action:
        description: 'Action to perform'
        required: true
        default: 'approve'  # 기본값을 'approve'로 설정
        options:
          - approve
          - deny

permissions:
  pull-requests: write
  contents: write

jobs:
  approve-and-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Perform Action on PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.inputs.pr_number }}
          ACTION=${{ github.event.inputs.action }}
          REPO=${{ github.repository }}
          
          if [ "$ACTION" == "approve" ]; then
            echo "Approving PR #$PR_NUMBER"
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews \
              -d '{"event":"APPROVE"}'
            
            echo "Merging PR #$PR_NUMBER"
            curl -X PUT \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/merge \
              -d '{"merge_method":"merge"}'
          elif [ "$ACTION" == "deny" ]; then
            echo "Closing PR #$PR_NUMBER"
            curl -X PATCH \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/pulls/$PR_NUMBER \
              -d '{"state":"closed"}'
          fi
